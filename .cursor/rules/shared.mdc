---
description: 
globs: 
alwaysApply: true
---
# AI Rules for {app-name}

{project-description}

## Tech Stack

- Astro 5
- TypeScript 5
- React 19
- Tailwind 4
- Shadcn/ui
- Bun (package manager)

## Project Structure

When introducing changes to the project, always follow the directory structure below:

- `./src` - source code
- `./src/layouts` - Astro layouts
- `./src/pages` - Astro pages
- `./src/pages/api` - API endpoints
- `./src/middleware/index.ts` - Astro middleware
- `./src/db` - Supabase clients and types
- `./src/types.ts` - Shared types for backend and frontend (Entities, DTOs)
- `./src/components` - Client-side components written in Astro (static) and React (dynamic)
- `./src/components/ui` - Client-side components from Shadcn/ui
- `./src/lib` - Services and helpers
- `./src/assets` - static internal assets
- `./public` - public assets

When modifying the directory structure, always update this section.

## Coding practices

### Guidelines for clean code

- Use feedback from linters to improve the code when making changes.
- Prioritize error handling and edge cases.
- Handle errors and edge cases at the beginning of functions.
- Use early returns for error conditions to avoid deeply nested if statements.
- Place the happy path last in the function for improved readability.
- Avoid unnecessary else statements; use if-return pattern instead.
- Use guard clauses to handle preconditions and invalid states early.
- Implement proper error logging and user-friendly error messages.
- Consider using custom error types or error factories for consistent error handling.

## Package Management

### Bun

- Use Bun as the default package manager for Node.js dependencies.
- Run `bun install` to install dependencies; avoid `npm install` or `yarn`.
- Use `bun run <script>` to execute project scripts defined in `package.json` or `bunfig.toml`.
- When adding new scripts or documentation, prefer Bun commands (e.g., `bunx` instead of `npx`).
- Ensure any shell commands in documentation or CI pipelines invoke Bun commands.
- For Windows environments, scripts should be compatible with PowerShell (`pwsh`) as per user rules.

## API Endpoints & Cloudflare Workers

### Request Handling in Cloudflare Workers

**CRITICAL**: When working with `Request` objects in API endpoints (especially when deployed to Cloudflare Pages/Workers), always use the safe request utilities to prevent "Illegal invocation" errors.

- **NEVER** call `request.json()` or `request.text()` directly on Request objects in API routes.
- **ALWAYS** use `safeRequestJson(request)` from `@/lib/utils/request.utils` instead.
- This prevents `TypeError: Illegal invocation` errors that occur when Request methods lose their `this` context in Cloudflare Workers runtime.

**Example:**
```typescript
// ❌ WRONG - Can cause "Illegal invocation" error in Cloudflare Workers
const body = await context.request.json();

// ✅ CORRECT - Safe for Cloudflare Workers
import { safeRequestJson } from "@/lib/utils/request.utils";
const body = await safeRequestJson(context.request);
```

**Why this is needed:**
- Cloudflare Workers use special runtime objects that require proper `this` context.
- Methods like `json()` and `text()` can lose their context when called directly, especially during long-running operations (>5 seconds).
- The safe utilities use `Request.prototype.json.call(request)` to explicitly preserve the `this` context.
- This issue is documented in Cloudflare's error guide: https://developers.cloudflare.com/workers/observability/errors/#illegal-invocation-errors

**When to use:**
- All API endpoints that parse request bodies (`POST`, `PUT`, `PATCH`).
- Any endpoint that might run longer than a few seconds (e.g., AI generation endpoints).
- Better to be safe: use `safeRequestJson()` everywhere instead of `request.json()`.
